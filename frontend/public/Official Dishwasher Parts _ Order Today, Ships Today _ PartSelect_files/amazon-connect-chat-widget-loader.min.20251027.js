class ChatWidgetLoader{constructor(n){n&&n.awsParameters&&(this.siteConfig=n,this.chatWidgetConfig=n.awsParameters.chatWidget,this.rootElemId="amazon-connect-chat-widget-window",this.storageType="localStorage",this.systemMessage="Chat with PartSelect",this.bot="Customer Service",this.customerName="Customer",this.CHAT_PERSISTENCE_KEY="awsChatSessionData",this.AGENT_NAME_KEY="awsAgentName",this.container=document.getElementById("amazon-connect-chat-widget"),this.startButton=document.getElementById("amazon-connect-start-widget-button"),this.minimizeButton=document.getElementById("amazon-connect-minimize-widget-button"),this.awsChatWidgetChannel=new BroadcastChannel("awsChatWidget"),this.init(),this.addEventListeners())}init(){connect.ChatInterface.init({containerId:this.rootElemId});connect.EventBus.on("awsChatRehydrateSuccessful",()=>{this.toggleButtons(!0)});window.location.pathname.toLowerCase().startsWith("/order-confirmation/")&&this.GA4OrderReferenceEvent()}addEventListeners(){this.startButton&&this.startButton.addEventListener("click",this.handleStartChat.bind(this));this.minimizeButton&&this.minimizeButton.addEventListener("click",this.handleMinimizeChat.bind(this));this.awsChatWidgetChannel.onmessage=n=>{n.data.action==="close"&&this.toggleButtons(!1)};connect.EventBus.on("awsAgentJoined",this.handleAgentJoined.bind(this));connect.EventBus.on("agentEndChat",this.handleChatEnded.bind(this));connect.EventBus.on("awsEndChat",this.handleChatEnded.bind(this));connect.EventBus.on("awsCloseChat",this.handleAwsCloseChat.bind(this));connect.EventBus.on("awsFeedback",this.handleFeedback.bind(this))}getContactID(){const n=localStorage.getItem(this.CHAT_PERSISTENCE_KEY)||sessionStorage.getItem(this.CHAT_PERSISTENCE_KEY);if(!n)return"MissingContactId";try{const t=JSON.parse(n);return t.chatDetails.startChatResult.ContactId}catch(t){return console.error("Failed to parse chat session data:",t),"InvalidSessionData"}}toggleButtons(n){n?this.container.classList.add("chat-active"):this.container.classList.remove("chat-active")}async handleStartChat(n){n.preventDefault();this.toggleButtons(!0);const{siteID:i,siteName:r}=this.siteConfig,{region:u,apiGatewayEndpoint:f,contactFlowId:e,instanceId:o,styles:s}=this.chatWidgetConfig,t=document.querySelector(".js-username");this.customerName=t&&t.dataset.userFirstName?t.dataset.userFirstName:"Customer";try{connect.ChatInterface.initiateChat({name:this.customerName,region:u,apiGatewayEndpoint:f,contactFlowId:e,instanceId:o,contactAttributes:JSON.stringify({customerName:this.customerName,siteID:i,siteName:r}),featurePermissions:{ATTACHMENTS:!0},supportedMessagingContentTypes:"text/plain",configuration:{disableImmediateDisconnect:!0,chatPersistence:this.storageType,headerSetting:{headerText:"How can we help?",subText:"",headerWrapperStyle:{bgColor:s.bgColor,padding:"12px 0px"},welcomeTextStyle:{fontSize:"17px",padding:"0px"}},enablePrintable:!0,messageDisplayNames:{systemMessage:this.systemMessage,bot:this.bot},enableMarkDownLinksForIncomingMessage:!0,enableFeedback:{set:!0,hideAfterVote:!1},enableInputAfter:5}},()=>{dataLayer.push({event:"lexchat_widget_click",lexchat_widget_click:{chatid:this.getContactID(),page:window.location.href}})},n=>{console.log("Chat initiation failed: ",n)})}catch(h){console.error("Error in chat initiation:",h)}}handleMinimizeChat(n){n.preventDefault();this.toggleButtons(!1);this.awsChatWidgetChannel.postMessage({action:"close"})}handleAgentJoined(n){dataLayer.push({event:"lexchat_connected_to_agent",lexchat_connected_to_agent:{chatid:this.getContactID(),agentname:n.agentName}});localStorage.setItem(this.AGENT_NAME_KEY,n.agentName)}handleChatEnded(){dataLayer.push({event:"lexchat_closed",lexchat_closed:{chatid:this.getContactID(),page:window.location.href}});localStorage.removeItem(this.AGENT_NAME_KEY)}handleAwsCloseChat(){this.toggleButtons(!1);this.awsChatWidgetChannel.postMessage({action:"close"})}handleFeedback(n){dataLayer.push({event:"lexchat_feedback",lexchat_feedback:{chatid:this.getContactID(),page:window.location.href,feedback:n.selectedOption==="up"?"like":"dislike"}})}GA4OrderReferenceEvent(){const n=localStorage.getItem(this.AGENT_NAME_KEY)||"AgentNameNotAvailable",t=new URLSearchParams(window.location.search);dataLayer.push({event:"lexchat_order_reference",lexchat_order_reference:{chatid:this.getContactID(),orderid:t.get("orderid"),agentname:n}})}}